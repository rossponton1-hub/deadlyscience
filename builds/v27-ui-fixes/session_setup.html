<!doctype html><html lang='en-AU'><head><meta charset='utf-8'/><meta name='viewport' content='width=device-width,initial-scale=1'/><title>Create / Plan Session</title>
<style>
.skip-link{position:absolute;left:-999px;top:auto;width:1px;height:1px;overflow:hidden}
.skip-link:focus{position:fixed;left:16px;top:16px;width:auto;height:auto;padding:12px 16px;background:var(--charcoal);color:var(--white);z-index:10000;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.25)}

:root{--ink:#111827;--charcoal:#1f2937;--muted:#6b7280;--bg:#f3f4f6;--white:#fff;--line:#e5e7eb;--green:#0a7d57;--red:#b91c1c}
*{box-sizing:border-box}body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--charcoal)}
a{color:var(--charcoal);text-decoration:none}
.wrap{max-width:1100px;margin:0 auto;padding:16px}
.card{background:var(--white);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 4px 18px rgba(0,0,0,.06)}
.btn{display:inline-block;background:var(--charcoal);color:#fff;padding:10px 14px;border-radius:10px;border:0;cursor:pointer}
.btn.ghost{background:transparent;color:var(--charcoal);border:1px solid var(--line)}
.btn.primary{background:var(--green)}
.btn.danger{background:var(--red)}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
label{display:block;font-weight:600;margin-top:8px}
.row{display:grid;gap:12px}
@media(min-width:900px){.row.cols-2{grid-template-columns:1fr 1fr}.row.cols-3{grid-template-columns:repeat(3,1fr)}}
.pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px;cursor:pointer}
.warning{background:#FEF2F2;border:1px solid #FECACA;color:#991B1B;padding:12px;border-radius:12px;margin-bottom:12px}
.ok{background:#ECFDF5;border:1px solid #A7F3D0;color:#065F46;padding:12px;border-radius:12px;margin-bottom:12px}
.info{background:#DBEAFE;border:1px solid #93C5FD;color:#1E40AF;padding:12px;border-radius:12px;margin-bottom:12px}
.muted{color:var(--muted)}
.nav{display:flex;gap:10px;flex-wrap:wrap}
.lookup{position:relative}
.lookup .results{position:absolute;z-index:20;left:0;right:0;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.08);max-height:220px;overflow:auto}
.lookup .item{padding:8px 10px;border-bottom:1px solid #f3f4f6;cursor:pointer}
.lookup .item:hover{background:#f9fafb}
.lookup .item:last-child{border-bottom:0}
.pillbox{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
.pillbox .pill{background:#e5f9f1;color:#065F46}
.contact-form{background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;padding:12px;margin-top:8px}
header{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid #e5e7eb}
.checkbox-group{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:8px}
.checkbox-group label{display:flex;align-items:center;font-weight:400;margin:0}
.checkbox-group input[type="checkbox"]{width:auto;margin-right:8px}
</style>
</head><body>
<a class="skip-link" href="#main-content">Skip to main content</a>
<header>
<div class="wrap" style="display:flex;align-items:center;justify-content:space-between;">
<strong>DeadlyScience Prototype</strong>
<nav class="nav"><a class="btn ghost" href="index.html">Index</a></nav>
</div>
</header>
<main id="main-content" tabindex="-1" class='wrap' style='padding-top:16px;' role="main">
<h1 style="margin:0 0 10px 0;">Create / Plan Session</h1>
<div class="row cols-2">
<div class="card">
<label>Session Name / Title (required)</label>
<input id="SessionName" placeholder="e.g., 'Redfern PS - DeadlyLabs Bush Soap Workshop - Nov 2025'"/>
<div class="muted" style="margin-top:4px;font-size:13px;">A descriptive name to identify this session in reports and lists</div>

<label>Program</label>
<select id="ProgramSelect">
<option value=""></option>
</select>
<script>
document.addEventListener('DOMContentLoaded', function(){
  const p=document.getElementById('ProgramSelect');
  (window.PROGRAMS||[]).forEach(function(x){ const o=document.createElement('option'); o.textContent=x; p.appendChild(o); });
});
</script>

<label>Topic</label>
<select id="TopicSelect">
<option value="">Select topic...</option>
<option>Introduction to Robotics</option>
<option>Renewable Energy Basics</option>
<option>Marine Ecosystems</option>
<option>Coding with Python</option>
<option>DNA & Genetics</option>
<option>Climate Change Science</option>
<option>Aboriginal Star Knowledge</option>
<option>Microscopy Skills</option>
<option>3D Printing & Design</option>
<option>Water Quality Testing</option>
<option>Space Exploration</option>
<option>Coral Reef Biology</option>
<option>Solar Power Engineering</option>
<option>Other (specify in notes)</option>
</select>

<label>Location / Venue</label>
<input id="Location" placeholder="e.g., 'School Hall', 'Zoom: https://zoom.us/j/123', 'Community Center'"/>
<div class="muted" style="margin-top:4px;font-size:13px;">Physical location or online meeting link</div>

<label>Estimated Students</label>
<input type="number" id="EstStudents" placeholder="Expected number of participants" min="1"/>
<div class="muted" style="margin-top:4px;font-size:13px;">For planning purposes - actual count will be recorded during delivery</div>

<label>Contact Type</label>
<select id="ContactType" onchange="updateContactLookup()">
<option value="school">School (ACARA)</option>
<option value="nonschool">Non-School Contact (Library, Juv Justice, Community)</option>
</select>

<div id="SchoolLookupSection">
<label>School(s) & Teacher Contacts</label>
<div class="lookup">
<input id="SchoolLookup" placeholder="Start typing school name & select..." oninput="typeahead('SchoolLookup', window.SCHOOLS, (x)=>x.name+' â€“ '+x.state+' (ACARA '+x.acara+')', addSchoolWithContact)"/>
<div class="results"></div>
</div>
<div id="SelectedSchools" class="pillbox" style="margin-top:6px;"></div>
<div id="school-count" class="muted" style="margin-top:4px;font-size:13px;"></div>
<div id="SchoolContactForms"></div>
</div>

<div id="NonSchoolSection" style="display:none;">
<label>Non-School Contacts</label>
<div class="info" style="margin-bottom:12px;">
<strong>ðŸ“‹ Salesforce Behavior:</strong> Search existing non-school contacts by organization name or contact person. If not found, create new contact record.
</div>
<div class="lookup">
<input id="NonSchoolLookup" placeholder="Type organization or contact name..." oninput="searchNonSchoolContacts()"/>
<div class="results" id="NonSchoolResults"></div>
</div>
<div id="SelectedNonSchools" class="pillbox" style="margin-top:6px;"></div>
<div id="nonschool-count" class="muted" style="margin-top:4px;font-size:13px;"></div>
<div id="NonSchoolContactForms"></div>
</div>

<label>Primary Facilitator</label>
<div class="lookup">
<input id="PrimaryFac" placeholder="Type to search facilitator..." oninput="typeahead('PrimaryFac', window.USERS, (x)=>x, (pick)=>{ document.getElementById('PrimaryFac').value=pick; })"/>
<div class="results"></div>
</div>

<label>Supporting Facilitator(s)</label>
<div class="lookup">
<input id="SupportFac" placeholder="Type to search & add..." oninput="typeahead('SupportFac', window.USERS, (x)=>x, (pick)=>{ addChip('SupportPills', pick); document.getElementById('SupportFac').value=''; })"/>
<div class="results"></div>
</div>
<div id="SupportPills" class="pillbox"></div>

<label>Date</label>
<input type="datetime-local" id="SessionDate"/>

<label>Delivery Mode</label>
<select id="DeliveryMode">
<option></option>
<option>In-person</option>
<option>Virtual</option>
<option>Hybrid</option>
</select>

<label>Status</label>
<select id="SessionStatus">
<option>Draft</option>
<option>Confirmed</option>
<option>In Progress</option>
<option>Completed</option>
<option>Cancelled</option>
</select>
<div class="muted" style="margin-top:4px;font-size:13px;">Draft = planning stage; Confirmed = ready to deliver</div>

<label>Funded By (Grant) - Hold Ctrl/Cmd to select multiple</label>
<select id="GrantFunding" multiple size="6">
<option value="">No specific grant</option>
<option>Atlassian Corporate Grant 2024</option>
<option>Women NSW - Indigenous STEM 2025</option>
<option>Commonwealth - Education Innovation</option>
<option>Acme Foundation General</option>
<option>Regional Schools Initiative</option>
<option>Corporate Partnership Fund</option>
<option>Untied Funding</option>
</select>
<div class="muted" style="margin-top:4px;font-size:13px;">Link this session to grants for reporting (optional, multi-select)</div>

<label>Year Levels</label>
<div style="margin-bottom:8px;">
<label style="display:flex;align-items:center;font-weight:400;margin:0;">
<input type="checkbox" id="YearLevelsNA" onchange="toggleYearLevels()" style="width:auto;margin-right:8px;"/>
Not Applicable (community group, all ages, non-school)
</label>
</div>
<div id="YearLevelsCheckboxes" class="checkbox-group">
<label><input type="checkbox" name="year" value="K"/> Kindergarten</label>
<label><input type="checkbox" name="year" value="1"/> Year 1</label>
<label><input type="checkbox" name="year" value="2"/> Year 2</label>
<label><input type="checkbox" name="year" value="3"/> Year 3</label>
<label><input type="checkbox" name="year" value="4"/> Year 4</label>
<label><input type="checkbox" name="year" value="5"/> Year 5</label>
<label><input type="checkbox" name="year" value="6"/> Year 6</label>
<label><input type="checkbox" name="year" value="7"/> Year 7</label>
<label><input type="checkbox" name="year" value="8"/> Year 8</label>
<label><input type="checkbox" name="year" value="9"/> Year 9</label>
<label><input type="checkbox" name="year" value="10"/> Year 10</label>
<label><input type="checkbox" name="year" value="11"/> Year 11</label>
<label><input type="checkbox" name="year" value="12"/> Year 12</label>
</div>

<label>Notes (optional)</label>
<textarea id="SessionNotes" rows="3" placeholder="Special requirements, dietary needs, accessibility considerations, venue instructions, etc."></textarea>

<div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;">
<button class="btn primary" onclick="saveSession()">Save Session</button>
<button class="btn ghost" onclick="saveDraft()">Save as Draft</button>
</div>
</div>

<div class="card">
<h3 style="margin:0 0 12px 0;">Session Links</h3>
<div style="margin-bottom:12px;">
<button class="btn primary" onclick="generateSessionLinks()">Generate Session Links</button>
</div>

<div id="survey-outputs" style="display:none;">
<div class="ok" style="margin-bottom:16px;">âœ“ Session links generated</div>

<h3 style="margin:0 0 8px 0;">Student Survey</h3>
<div class="row" style="align-items:flex-start;margin-bottom:16px;">
<div id="qr-student" style="min-width:180px;min-height:180px;"></div>
<div style="flex:1;">
<div><label>Session Ref</label><input id="session-ref" value="" readonly/></div>
<div><label>Student Survey Link</label><input id="student-link" value="" readonly/></div>
<div style="margin-top:10px;display:flex;gap:8px;">
<button class="btn ghost" onclick="copyLink('student-link')">Copy link</button>
</div>
</div>
</div>

<hr style="border:none;border-top:1px solid #eee;margin:16px 0;">

<h3 style="margin:0 0 8px 0;">Teacher Survey</h3>
<div class="row" style="align-items:flex-start;">
<div id="qr-teacher" style="min-width:180px;min-height:180px;"></div>
<div style="flex:1;">
<div><label>Teacher Survey Link</label><input id="teacher-link" value="" readonly/></div>
<div style="margin-top:10px;display:flex;gap:8px;">
<button class="btn ghost" onclick="copyLink('teacher-link')">Copy link</button>
</div>
</div>
</div>
</div>
</div>
</div>
</main>

<script>
let schoolsWithContacts = [];
let nonSchoolContacts = [];

// Existing Salesforce Contacts for teacher lookup
const EXISTING_TEACHER_CONTACTS = [
  {name:"Ms. Emma Riley", email:"emma.riley@redfern.nsw.edu.au", school:"Redfern PS"},
  {name:"Mr. Jacob Tan", email:"jacob.tan@dubbo.nsw.edu.au", school:"Dubbo College"},
  {name:"Mrs. Priya Singh", email:"priya.singh@kempsey.nsw.edu.au", school:"Kempsey PS"},
  {name:"Dr. Alan Torres", email:"alan.torres@holsworthy.nsw.edu.au", school:"Holsworthy HS"}
];

// Existing Salesforce Non-School Contacts
const EXISTING_NONSCHOOL_CONTACTS = [
  {id:'ns1',type:'Library',org:'Redfern Community Library',person:'Ms. Linda Chen',email:'l.chen@redfernlib.nsw.gov.au',location:'Redfern, NSW'},
  {id:'ns2',type:'Juvenile Justice',org:'Reiby Juvenile Justice Centre',person:'Mr. Peter Wang',email:'p.wang@dcj.nsw.gov.au',location:'Airds, NSW'},
  {id:'ns3',type:'Community Center',org:'Blacktown Youth Hub',person:'Ms. Rachel Green',email:'r.green@blacktown.nsw.gov.au',location:'Blacktown, NSW'},
  {id:'ns4',type:'Library',org:'Liverpool City Library',person:'Mr. David Kim',email:'d.kim@liverpool.nsw.gov.au',location:'Liverpool, NSW'}
];

function updateContactLookup() {
  const type = document.getElementById('ContactType').value;
  document.getElementById('SchoolLookupSection').style.display = type === 'school' ? 'block' : 'none';
  document.getElementById('NonSchoolSection').style.display = type === 'nonschool' ? 'block' : 'none';
}

function addSchoolWithContact(school) {
  const schoolId = 'school-' + Date.now();
  schoolsWithContacts.push({
    id: schoolId,
    name: school.name,
    state: school.state,
    acara: school.acara,
    teacherName: '',
    teacherEmail: '',
    teacherContactId: null
  });
  
  renderSchools();
  document.getElementById('SchoolLookup').value = '';
}

function renderSchools() {
  const pills = schoolsWithContacts.map(s => 
    `<span class="pill" onclick="toggleContactForm('${s.id}')">${s.name} <span onclick="event.stopPropagation();removeSchool('${s.id}')" style="margin-left:4px;cursor:pointer;">âœ•</span></span>`
  ).join('');
  
  document.getElementById('SelectedSchools').innerHTML = pills;
  
  const count = schoolsWithContacts.length;
  document.getElementById('school-count').textContent = count === 0 ? '' : (count === 1 ? '1 school added' : count + ' schools added');
  
  const forms = schoolsWithContacts.map(s => `
    <div class="contact-form" id="form-${s.id}">
      <strong>${s.name} â€“ Teacher Contact</strong>
      <div class="info" style="font-size:12px;margin-top:4px;">
        <strong>ðŸ“‹ Salesforce Behavior:</strong> Type teacher name or email below. System will:<br>
        â€¢ <strong>Find existing:</strong> If email matches Contact__c, link to existing record<br>
        â€¢ <strong>Create new:</strong> If email not found, create new Contact__c record<br>
        â€¢ No duplicate Contacts created - email is unique key
      </div>
      <label style="font-size:14px;margin-top:8px;">Teacher Name</label>
      <div class="lookup">
        <input id="name-${s.id}" type="text" placeholder="Type to search existing teachers..." value="${s.teacherName}" oninput="searchTeacherContact('${s.id}',this.value)"/>
        <div class="results" id="teacher-results-${s.id}"></div>
      </div>
      <label style="font-size:14px;margin-top:4px;">Teacher Email</label>
      <input id="email-${s.id}" type="email" placeholder="e.g., emma.riley@redfern.nsw.edu.au" value="${s.teacherEmail}" oninput="updateSchoolData('${s.id}','email',this.value)"/>
      <div id="contact-status-${s.id}" class="muted" style="margin-top:4px;font-size:12px;"></div>
      <div class="muted" style="margin-top:6px;font-size:13px;">Click the school chip above to collapse/expand this form</div>
    </div>
  `).join('');
  
  document.getElementById('SchoolContactForms').innerHTML = forms;
}

function searchTeacherContact(schoolId, query) {
  const school = schoolsWithContacts.find(s => s.id === schoolId);
  if(!school) return;
  
  school.teacherName = query;
  
  const results = document.getElementById('teacher-results-' + schoolId);
  if(!results) return;
  
  if(query.length < 2) {
    results.innerHTML = '';
    return;
  }
  
  const filtered = EXISTING_TEACHER_CONTACTS.filter(c => 
    c.name.toLowerCase().includes(query.toLowerCase()) ||
    c.email.toLowerCase().includes(query.toLowerCase())
  );
  
  if(filtered.length === 0) {
    results.innerHTML = '<div class="item" style="color:#059669;font-weight:600;">âœ¨ Create new contact: ' + query + '</div>';
    updateContactStatus(schoolId, 'new', query);
    return;
  }
  
  results.innerHTML = filtered.map(c => 
    `<div class="item" onclick='selectTeacherContact("${schoolId}", ${JSON.stringify(c)})'>${c.name}<br><span style="font-size:11px;color:#6b7280;">${c.email} â€¢ ${c.school}</span></div>`
  ).join('');
}

function selectTeacherContact(schoolId, contact) {
  const school = schoolsWithContacts.find(s => s.id === schoolId);
  if(!school) return;
  
  school.teacherName = contact.name;
  school.teacherEmail = contact.email;
  school.teacherContactId = contact.email; // In real system: Salesforce Contact ID
  
  document.getElementById('name-' + schoolId).value = contact.name;
  document.getElementById('email-' + schoolId).value = contact.email;
  document.getElementById('teacher-results-' + schoolId).innerHTML = '';
  
  updateContactStatus(schoolId, 'existing', contact.name);
}

function updateContactStatus(schoolId, status, name) {
  const statusDiv = document.getElementById('contact-status-' + schoolId);
  if(!statusDiv) return;
  
  if(status === 'existing') {
    statusDiv.innerHTML = `<span style="color:#059669;">âœ“ Existing contact found: ${name}</span>`;
  } else if(status === 'new') {
    statusDiv.innerHTML = `<span style="color:#0284c7;">âœ¨ Will create new contact: ${name}</span>`;
  }
}

function updateSchoolData(schoolId, field, value) {
  const school = schoolsWithContacts.find(s => s.id === schoolId);
  if(school) {
    if(field === 'email') school.teacherEmail = value;
  }
}

function toggleContactForm(schoolId) {
  const form = document.getElementById('form-' + schoolId);
  if(form) {
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
  }
}

function removeSchool(schoolId) {
  schoolsWithContacts = schoolsWithContacts.filter(s => s.id !== schoolId);
  renderSchools();
}

function searchNonSchoolContacts() {
  const query = document.getElementById('NonSchoolLookup').value.toLowerCase();
  const results = document.getElementById('NonSchoolResults');
  
  if(query.length < 2) {
    results.innerHTML = '';
    return;
  }
  
  const filtered = EXISTING_NONSCHOOL_CONTACTS.filter(c => 
    c.org.toLowerCase().includes(query) ||
    c.person.toLowerCase().includes(query) ||
    c.location.toLowerCase().includes(query)
  );
  
  if(filtered.length === 0) {
    results.innerHTML = '<div class="item" style="color:#059669;font-weight:600;" onclick="createNonSchoolContact(\'' + query + '\')">âœ¨ Create new organization: ' + query + '</div>';
    return;
  }
  
  results.innerHTML = filtered.map(c => 
    `<div class="item" onclick='addNonSchoolContact(${JSON.stringify(c)})'><strong>${c.org}</strong> - ${c.type}<br><span style="font-size:11px;color:#6b7280;">${c.person} â€¢ ${c.email} â€¢ ${c.location}</span></div>`
  ).join('');
}

function addNonSchoolContact(contact) {
  if(nonSchoolContacts.find(c => c.id === contact.id)) {
    alert('Contact already added');
    return;
  }
  
  nonSchoolContacts.push(contact);
  renderNonSchools();
  document.getElementById('NonSchoolLookup').value = '';
  document.getElementById('NonSchoolResults').innerHTML = '';
}

function createNonSchoolContact(query) {
  const newContact = {
    id: 'new-' + Date.now(),
    type: 'Other',
    org: query,
    person: '',
    email: '',
    location: '',
    isNew: true
  };
  
  nonSchoolContacts.push(newContact);
  renderNonSchools();
  document.getElementById('NonSchoolLookup').value = '';
  document.getElementById('NonSchoolResults').innerHTML = '';
}

function renderNonSchools() {
  const pills = nonSchoolContacts.map(c => 
    `<span class="pill" onclick="toggleNonSchoolForm('${c.id}')">${c.org} <span onclick="event.stopPropagation();removeNonSchool('${c.id}')" style="margin-left:4px;cursor:pointer;">âœ•</span></span>`
  ).join('');
  
  document.getElementById('SelectedNonSchools').innerHTML = pills;
  
  const count = nonSchoolContacts.length;
  document.getElementById('nonschool-count').textContent = count === 0 ? '' : (count === 1 ? '1 contact added' : count + ' contacts added');
  
  const forms = nonSchoolContacts.map(c => `
    <div class="contact-form" id="nsform-${c.id}">
      <strong>${c.org}</strong>
      ${c.isNew ? '<div class="info" style="font-size:12px;margin-top:4px;"><strong>âœ¨ New Contact:</strong> Complete details below - will create Contact__c record in Salesforce</div>' : '<div class="ok" style="font-size:12px;margin-top:4px;"><strong>âœ“ Existing Contact:</strong> Linked to Salesforce Contact__c record</div>'}
      <label style="font-size:14px;margin-top:8px;">Organization Type</label>
      <select id="nstype-${c.id}" ${c.isNew ? '' : 'disabled'}>
        <option ${c.type==='Library'?'selected':''}>Library</option>
        <option ${c.type==='Juvenile Justice'?'selected':''}>Juvenile Justice</option>
        <option ${c.type==='Community Center'?'selected':''}>Community Center</option>
        <option ${c.type==='Youth Program'?'selected':''}>Youth Program</option>
        <option ${c.type==='Other'?'selected':''}>Other</option>
      </select>
      <label style="font-size:14px;margin-top:4px;">Contact Person</label>
      <input id="nsperson-${c.id}" type="text" value="${c.person}" ${c.isNew ? '' : 'readonly'} placeholder="e.g., Ms. Linda Chen"/>
      <label style="font-size:14px;margin-top:4px;">Email</label>
      <input id="nsemail-${c.id}" type="email" value="${c.email}" ${c.isNew ? '' : 'readonly'} placeholder="email@example.com"/>
      <label style="font-size:14px;margin-top:4px;">Location</label>
      <input id="nslocation-${c.id}" type="text" value="${c.location}" ${c.isNew ? '' : 'readonly'} placeholder="City, State"/>
      <div class="muted" style="margin-top:6px;font-size:13px;">Click organization chip above to collapse/expand</div>
    </div>
  `).join('');
  
  document.getElementById('NonSchoolContactForms').innerHTML = forms;
}

function toggleNonSchoolForm(id) {
  const form = document.getElementById('nsform-' + id);
  if(form) {
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
  }
}

function removeNonSchool(id) {
  nonSchoolContacts = nonSchoolContacts.filter(c => c.id !== id);
  renderNonSchools();
}

function toggleYearLevels() {
  const na = document.getElementById('YearLevelsNA').checked;
  const checkboxes = document.getElementById('YearLevelsCheckboxes');
  
  if(na) {
    checkboxes.style.opacity = '0.3';
    checkboxes.style.pointerEvents = 'none';
    document.querySelectorAll('input[name="year"]').forEach(cb => cb.checked = false);
  } else {
    checkboxes.style.opacity = '1';
    checkboxes.style.pointerEvents = 'auto';
  }
}

function ensureRef(){ if(!getSessionRef()){ setSessionRef(genSessionRef()); } }

function generateSessionLinks(){
  ensureRef();
  const ref = getSessionRef();
  const studentLink = 'https://survey.deadlyscience.org/s/student?session=' + ref;
  const teacherLink = 'https://survey.deadlyscience.org/s/teacher?session=' + ref;
  
  setStudentLink(studentLink);
  setTeacherLink(teacherLink);
  
  document.getElementById('session-ref').value = ref;
  document.getElementById('student-link').value = studentLink;
  document.getElementById('teacher-link').value = teacherLink;
  document.getElementById('qr-student').innerHTML = sampleQR(180,400);
  document.getElementById('qr-teacher').innerHTML = sampleQR(180,400);
  document.getElementById('survey-outputs').style.display = 'block';
}

function copyLink(id){ 
  const el=document.getElementById(id); 
  if(!el || !el.value) return alert('No link to copy.'); 
  try{ 
    navigator.clipboard && navigator.clipboard.writeText(el.value); 
    alert('Copied.'); 
  }catch(e){ 
    alert('Copy failed.'); 
  } 
}

function saveSession() {
  const contactType = document.getElementById('ContactType').value;
  
  if(contactType === 'school') {
    if(schoolsWithContacts.length === 0) {
      alert('Please add at least one school.');
      return;
    }
    
    let missingContacts = [];
    schoolsWithContacts.forEach(s => {
      if(!s.teacherName || !s.teacherEmail) {
        missingContacts.push(s.name);
      }
    });
    
    if(missingContacts.length > 0) {
      alert('Missing teacher contact for: ' + missingContacts.join(', '));
      return;
    }
  } else {
    if(nonSchoolContacts.length === 0) {
      alert('Please add at least one non-school contact.');
      return;
    }
  }
  
  alert('Session saved (mock). Schools: ' + schoolsWithContacts.map(s => s.name).join(', '));
}

function saveDraft() {
  alert('Draft saved (mock). You can return to complete this session later.');
}

function getSessionRef(){ return localStorage.getItem('ds_session_ref') || ''; }
function setSessionRef(v){ localStorage.setItem('ds_session_ref', v); }
function getStudentLink(){ return localStorage.getItem('ds_student_link') || ''; }
function setStudentLink(v){ localStorage.setItem('ds_student_link', v); }
function getTeacherLink(){ return localStorage.getItem('ds_teacher_link') || ''; }
function setTeacherLink(v){ localStorage.setItem('ds_teacher_link', v); }
function genSessionRef(){ return 'SESS-'+Math.random().toString(36).slice(2,7).toUpperCase(); }
function sampleQR(sz,cells){
  return `<svg xmlns="http://www.w3.org/2000/svg" width="${sz}" height="${sz}">
    <rect width="100%" height="100%" fill="#fff" stroke="#ddd"/>
    ${Array.from({length:cells}).map(()=>{
      const x=Math.floor(Math.random()*Math.floor(sz/5))*5; const y=Math.floor(Math.random()*Math.floor(sz/5))*5;
      return `<rect x="${x}" y="${y}" width="4" height="4" fill="${(x+y)%2===0?'#111':'#000'}"/>`;
    }).join('')}
  </svg>`;
}
</script>

<script>
window.SCHOOLS=[
  {name:"Redfern Public School", state:"NSW", acara:"12345"},
  {name:"Dubbo College Senior Campus", state:"NSW", acara:"98765"},
  {name:"Kempsey South Public School", state:"NSW", acara:"54321"},
  {name:"Holsworthy High School", state:"NSW", acara:"11223"}
];
window.USERS=["Anna Kowalski","Ben Walker","Chris Jackson","Jamie Wong","Priya Patel","Michael Smith"];
window.PROGRAMS=[
  "DeadlyScience â€“ DeadlyLabs â€“ Bush Soap",
  "DeadlyScience â€“ DeadlyLabs â€“ Rocket Mice",
  "DeadlyScience â€“ DeadlyLabs â€“ Water Testing",
  "DeadlyScience â€“ DeadlyLabs â€“ Solar Cars",
  "DeadlyScience â€“ Mentoring â€“ STEM Pathways",
  "DeadlyScience â€“ Workshop â€“ Robotics Taster"
];

function typeahead(inputId, list, renderer, onPick){
  const box = document.getElementById(inputId);
  const wrap = box.parentElement;
  let res = wrap.querySelector('.results');
  if(!res){ res = document.createElement('div'); res.className='results'; wrap.appendChild(res); }
  const q = box.value.toLowerCase();
  res.innerHTML = list.filter(x=>renderer(x).toLowerCase().includes(q)).slice(0,8).map(x=>`<div class="item">${renderer(x)}</div>`).join("");
  res.querySelectorAll('.item').forEach((el,i)=>{
    el.addEventListener('click',()=>{ onPick(list.filter(x=>renderer(x)===el.textContent)[0]); res.innerHTML=''; });
  });
}
function addChip(containerId, label){
  const c=document.getElementById(containerId);
  const span=document.createElement('span');
  span.className='pill'; span.textContent=label;
  span.onclick=()=>span.remove();
  c.appendChild(span);
}
</script>
</body></html>
