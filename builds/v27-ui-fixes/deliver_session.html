<!doctype html><html lang='en-AU'><head><meta charset='utf-8'/><meta name='viewport' content='width=device-width,initial-scale=1'/><title>Deliver Session</title>
<style>
.skip-link{position:absolute;left:-999px;top:auto;width:1px;height:1px;overflow:hidden}
.skip-link:focus{position:fixed;left:16px;top:16px;width:auto;height:auto;padding:12px 16px;background:var(--charcoal);color:var(--white);z-index:10000;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.25)}

:root{--ink:#111827;--charcoal:#1f2937;--muted:#6b7280;--bg:#f3f4f6;--white:#fff;--line:#e5e7eb;--green:#0a7d57;--red:#c62828;--amber:#f59e0b;--blue:#3b82f6}
*{box-sizing:border-box}
body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0f172a;color:var(--charcoal);padding:24px 0;min-height:100vh;display:flex;justify-content:center;align-items:center}
a{color:var(--charcoal);text-decoration:none}

/* Phone Frame */
.phone-frame{background:#1e293b;border-radius:48px;padding:16px;box-shadow:0 20px 60px rgba(0,0,0,0.5);max-width:400px;width:100%;margin:0 auto;position:relative}
.phone-frame::before{content:'';position:absolute;top:16px;left:50%;transform:translateX(-50%);width:120px;height:28px;background:#0f172a;border-radius:0 0 20px 20px;z-index:10}
.phone-screen{background:var(--bg);border-radius:32px;overflow:hidden;height:90vh;max-height:844px;display:flex;flex-direction:column;position:relative}
.phone-content{flex:1;overflow-y:auto;overflow-x:hidden}

.wrap{padding:12px}
.card{background:var(--white);border:1px solid var(--line);border-radius:12px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.06);margin-bottom:12px}
.btn{display:block;background:var(--charcoal);color:#fff;padding:14px;border-radius:10px;border:0;cursor:pointer;font-size:16px;font-weight:600;text-align:center;width:100%;transition:all 0.2s}
.btn:hover{opacity:0.9}
.btn.primary{background:var(--green)}
.btn.secondary{background:#3b82f6}
.btn.ghost{background:transparent;color:var(--charcoal);border:1px solid var(--line)}
.btn.small{padding:8px 12px;font-size:13px;width:auto}
.btn.danger{background:var(--red)}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:8px;background:#fff;font-size:15px}
label{display:block;font-weight:600;margin-top:12px;margin-bottom:6px}
.muted{color:var(--muted);font-size:13px}
header{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid #e5e7eb;padding:12px 0}
.qr-fullscreen{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:#fff;z-index:9999;justify-content:center;align-items:center;flex-direction:column}
.qr-fullscreen.active{display:flex}
.checkbox-group{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
.checkbox-group label{display:flex;align-items:center;font-weight:400;margin:0}
.checkbox-group input[type="checkbox"]{width:auto;margin-right:8px}
.success{background:#D1FAE5;border:1px solid #A7F3D0;color:#065F46;padding:12px;border-radius:8px;margin:12px 0}
.warning{background:#FEF3C7;border:1px solid #FDE68A;color:#92400e;padding:12px;border-radius:8px;margin:12px 0}
.error{background:#FEE2E2;border:1px solid #FCA5A5;color:#991B1B;padding:12px;border-radius:8px;margin:12px 0}
.school-card{padding:12px;background:#F9FAFB;border:2px solid #e5e7eb;border-radius:8px;margin-bottom:8px;cursor:pointer;transition:all 0.2s}
.school-card:hover{border-color:#9ca3af}
.school-card.skipped{background:#FEF3C7;border-color:#FDE68A}
.school-card.cancelled{background:#FEE2E2;border-color:#FCA5A5;opacity:0.7}
.status-chip{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:600}
.status-chip.complete{background:#D1FAE5;color:#065F46}
.status-chip.partial{background:#FEF3C7;color:#92400e}
.status-chip.pending{background:#F3F4F6;color:#6b7280}
.status-chip.skipped{background:#FEF3C7;color:#92400e}
.status-chip.cancelled{background:#FEE2E2;color:#991B1B}

/* Survey Checklist Styles */
.survey-checklist{background:#EEF2FF;border:2px solid #C7D2FE;border-radius:12px;padding:16px;margin:16px 0}
.survey-checklist-title{font-weight:700;font-size:15px;margin-bottom:12px;color:#1e40af}
.survey-item{display:flex;align-items:center;gap:12px;padding:10px;background:white;border-radius:8px;margin-bottom:8px;border:2px solid #e5e7eb;transition:all 0.2s}
.survey-item.completed{border-color:#86efac;background:#f0fdf4}
.survey-item-icon{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;background:#f3f4f6;border:2px solid #e5e7eb;transition:all 0.3s}
.survey-item.completed .survey-item-icon{background:#86efac;border-color:#22c55e;animation:checkPop 0.3s ease-out}
.survey-item-content{flex:1}
.survey-item-title{font-weight:600;font-size:14px;margin-bottom:2px}
.survey-item-status{font-size:12px;color:#6b7280}
.survey-item.completed .survey-item-status{color:#166534;font-weight:500}
.survey-actions{display:flex;gap:6px;margin-top:8px}
.survey-actions .btn{padding:8px 12px;font-size:13px;width:auto}

@keyframes checkPop{
  0%{transform:scale(0.8)}
  50%{transform:scale(1.1)}
  100%{transform:scale(1)}
}

.btn-group{display:flex;gap:8px;align-items:center}

/* Save button warning state */
.save-btn-container{position:relative}
.save-warning{background:#FEF3C7;border:2px solid #F59E0B;border-radius:8px;padding:12px;margin-bottom:12px;display:none}
.save-warning.show{display:block;animation:slideDown 0.3s ease-out}

@keyframes slideDown{
  from{opacity:0;transform:translateY(-10px)}
  to{opacity:1;transform:translateY(0)}
}

/* NEW: Editable field styles */
.editable-field{position:relative}
.editable-field input{border:2px solid transparent;transition:all 0.2s}
.editable-field input:focus{border-color:#3b82f6;background:#EFF6FF}
.field-edited-indicator{display:inline-block;margin-left:6px;padding:2px 6px;background:#FEF3C7;color:#92400e;border-radius:4px;font-size:11px;font-weight:600}
.edit-warning{background:#EFF6FF;border:2px solid #93C5FD;border-radius:8px;padding:10px;margin-bottom:12px;font-size:13px;display:none}
.edit-warning.show{display:block}
.edit-warning strong{color:#1e40af}

/* Audit log styles */
.audit-log{background:#F9FAFB;border:1px solid #e5e7eb;border-radius:8px;padding:12px;margin-top:12px;max-height:150px;overflow-y:auto}
.audit-log-title{font-weight:600;font-size:13px;margin-bottom:8px;color:#6b7280}
.audit-entry{font-size:12px;color:#6b7280;padding:6px;border-left:3px solid #e5e7eb;margin-bottom:6px;background:white}
.audit-entry-time{font-weight:600;color:#1f2937}

/* === MINIMAL FILTER CHIPS (Added for MVP filtering) === */
.filter-chips-row{padding:10px 12px;background:#fff;border-bottom:1px solid #e5e7eb;display:flex;flex-wrap:wrap;gap:6px;align-items:center}
.filter-chip{background:#f3f4f6;color:#1f2937;padding:6px 12px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;border:2px solid #e5e7eb;transition:all 0.2s;white-space:nowrap}
.filter-chip:hover{background:#e5e7eb}
.filter-chip.active{background:#EFF6FF;border-color:#3b82f6;color:#1e40af}
.filter-section-label{font-size:11px;color:#6b7280;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-right:6px}
</style>
</head><body>
<a class="skip-link" href="#main-content">Skip to main content</a>

<div class="phone-frame">
<div class="phone-screen">
<div class="phone-content">

<header>
<div class="wrap" style="display:flex;align-items:center;justify-content:space-between;">
<strong>Deliver Session</strong>
<a class="btn ghost small" href="index.html">Index</a>
</div>
<!-- Session Filter Toggle -->
<div class="wrap" style="padding-top:8px;border-top:1px solid #e5e7eb;margin-top:8px;">
<div style="display:flex;gap:12px;align-items:center;">
<label style="display:flex;align-items:center;font-size:14px;margin:0;cursor:pointer;">
<input type="radio" name="sessionFilter" value="mine" checked onchange="toggleSessionFilter()" style="width:auto;margin-right:6px;">
My Sessions
</label>
<label style="display:flex;align-items:center;font-size:14px;margin:0;cursor:pointer;">
<input type="radio" name="sessionFilter" value="all" onchange="toggleSessionFilter()" style="width:auto;margin-right:6px;">
Show All
</label>
</div>
<div id="ShowAllWarning" style="display:none;margin-top:8px;padding:8px;background:#FEF3C7;border-radius:6px;font-size:12px;color:#92400e;">
⚠️ Showing all sessions. Only deliver if covering another presenter.
</div>
</div>
</header>

<!-- Filter Chips Row (Added for MVP date/status filtering) -->
<div class="filter-chips-row" id="FilterChipsRow">
<span class="filter-section-label">Date:</span>
<button type="button" class="filter-chip" data-filter="date" data-value="past_7" onclick="toggleDateFilter('past_7')" aria-pressed="false">Past 7 days</button>
<button type="button" class="filter-chip active" data-filter="date" data-value="upcoming_90" onclick="toggleDateFilter('upcoming_90')" aria-pressed="true">Next 90 days</button>
<button type="button" class="filter-chip" data-filter="date" data-value="this_year" onclick="toggleDateFilter('this_year')" aria-pressed="false">This Year</button>
<span class="filter-section-label" style="margin-left:12px;">Status:</span>
<button type="button" class="filter-chip active" data-filter="status" data-value="Scheduled" onclick="toggleStatusFilter('Scheduled')" aria-pressed="true">Scheduled</button>
<button type="button" class="filter-chip" data-filter="status" data-value="Delivered" onclick="toggleStatusFilter('Delivered')" aria-pressed="false">Delivered</button>
</div>

<!-- Warning Banner (shown when viewing All Sessions) -->
<div id="ShowAllWarningBanner" style="display:none;margin:12px;padding:10px;background:#FEF3C7;border-radius:8px;font-size:13px;color:#92400e;border:1px solid #FDE68A;">
⚠️ <strong>Viewing All Sessions.</strong> Only deliver if covering someone else.
</div>


<main id="main-content" tabindex="-1" class='wrap' style='padding-top:12px;' role="main">

<!-- STATE 1: Session List View (Default) -->
<div id="SessionListView">
<h2 style="margin:0 0 16px 0;">📅 My Sessions</h2>

<!-- Current user's session (multi-school) -->
<div class="card session-card" data-session-id="SESS-501" data-scope="mine" data-date="2025-10-29" data-status="Scheduled" onclick="openSessionDetail('SESS-501')" style="cursor:pointer;border:2px solid #3b82f6;">
<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
<div>
<h3 style="margin:0 0 4px 0;">SESS-501 • Robotics Workshop</h3>
<div class="muted">Today 10:00 AM • 3 schools</div>
</div>
<span class="status-chip pending">🔴 Not Started</span>
</div>
<div style="font-size:13px;color:#6b7280;margin-top:8px;">
<strong>Presenters:</strong> Alex Brown + Jordan Smith<br>
<strong>Schools:</strong> Redfern PS, Dubbo College, Kempsey PS
</div>
</div>

</div>

<!-- Additional Sessions (shown only when "Show All" is active) -->
<div id="OtherSessionsList" style="display:none;">

<div class="card session-card" data-session-id="SESS-504" data-scope="all" data-date="2025-10-29" data-status="Scheduled" onclick="openSessionDetail('SESS-504')" style="cursor:pointer;border:2px solid #e5e7eb;">
<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
<div>
<h3 style="margin:0 0 4px 0;">SESS-504 • Marine Biology</h3>
<div class="muted">Today 11:30 AM • 1 school</div>
</div>
<span class="status-chip pending">🔴 Not Started</span>
</div>
<div style="font-size:13px;color:#6b7280;margin-top:8px;">
<strong>Presenter:</strong> Sarah Wilson (solo)<br>
<strong>School:</strong> Sydney High School
</div>
</div>

<div class="card session-card" data-session-id="SESS-506" data-scope="all" data-date="2025-10-29" data-status="Scheduled" onclick="openSessionDetail('SESS-506')" style="cursor:pointer;border:2px solid #e5e7eb;">
<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
<div>
<h3 style="margin:0 0 4px 0;">SESS-506 • Coding Fundamentals</h3>
<div class="muted">Today 2:00 PM • 1 school</div>
</div>
<span class="status-chip pending">🔴 Not Started</span>
</div>
<div style="font-size:13px;color:#6b7280;margin-top:8px;">
<strong>Presenters:</strong> Rob Chen + Alex Brown<br>
<strong>School:</strong> Dubbo West PS
</div>
</div>

<div class="card" onclick="openSessionDetail('SESS-508')" style="cursor:pointer;border:2px solid #e5e7eb;">
<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
<div>
<h3 style="margin:0 0 4px 0;">SESS-508 • Astronomy & Space</h3>
<div class="muted">Tomorrow 9:00 AM • 1 school</div>
</div>
<span class="status-chip pending">🔴 Not Started</span>
</div>
<div style="font-size:13px;color:#6b7280;margin-top:8px;">
<strong>Presenter:</strong> Casey Lee (solo)<br>
<strong>School:</strong> Newcastle Central PS
</div>
</div>

</div>

<!-- STATE 2: Session Detail View (Hidden by default) -->
<div id="SessionDetailView" style="display:none;">
<div id="BackToCompletenessLink" style="display:none;margin-bottom:12px;">
<a href="data_completeness.html" style="color:#3b82f6;font-size:14px;text-decoration:none;">← Back to Data Completeness</a>
</div>
<button class="btn ghost small" onclick="backToSessionList()" style="margin-bottom:12px;">← Back to Sessions</button>

<div class="card" id="CurrentSessionCard">
<h3 style="margin:0 0 4px 0;" id="SessionDetailTitle">Session: SESS-501</h3>
<div class="muted" style="margin-bottom:12px;" id="SessionDetailSubtitle">Robotics Workshop • Today 10:00 AM</div>
<div class="muted" style="font-size:12px;margin-bottom:12px;color:#6b7280;">
Used by presenters during delivery and coordinators for data corrections.
</div>
<div id="PresenterInfo" style="display:none;padding:8px;background:#EFF6FF;border-radius:6px;margin-bottom:12px;font-size:13px;">
<strong>Original Presenter:</strong> <span id="OriginalPresenterName">Alex Brown</span><br>
<strong>You're covering this session</strong>
</div>

<div class="success" id="PresenterToolsOnline" style="display:flex;flex-direction:column;gap:12px;margin-bottom:12px;">
  <div>
    <strong>Presenter Tools Online</strong><br>
    Live checklist updates <code>Session__c</code> attendance fields and triggers <code>Survey_Response__c</code> reminders in real time.
  </div>
  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
    <button class="btn secondary small" type="button" onclick="openPresenterTools()">🌐 Open Presenter Tools</button>
    <button class="btn ghost small" type="button" onclick="copyPresenterToolsLink()">🔗 Copy presenter link</button>
  </div>
  <p class="muted" id="PresenterToolsRestriction" style="margin:0;font-size:12px;">Only the assigned presenter can launch online tools.</p>
</div>

<!-- Editable Fields - Read-Only with Explicit Edit Buttons -->
<div style="margin-top:12px;">
<div data-edit-key="facilitator" style="padding:12px;background:#F9FAFB;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:8px;">
<label style="font-size:13px;margin-bottom:4px;color:#6b7280;">Presenter</label>
<div style="font-size:15px;font-weight:600;margin:4px 0;" id="PresenterDisplay">Alex Brown</div>
<button class="btn ghost small" onclick="openChangePresenter()" style="margin-top:4px;">✏️ Change Presenter</button>
</div>

<div style="padding:12px;background:#F9FAFB;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:8px;">
<label style="font-size:13px;margin-bottom:4px;color:#6b7280;">Supporting Presenters</label>
<div style="font-size:15px;font-weight:600;margin:4px 0;" id="SupportingDisplay">Jordan Smith</div>
<div class="btn-group" style="margin-top:4px;">
<button class="btn ghost small" onclick="openEditSupporters()">✏️ Edit Supporters</button>
<button class="btn ghost small" onclick="openAddSupporter()">➕ Add Supporter</button>
</div>
</div>

<div style="padding:12px;background:#F9FAFB;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:12px;">
<label style="font-size:13px;margin-bottom:4px;color:#6b7280;">Topic</label>
<div style="font-size:15px;font-weight:600;margin:4px 0;" id="TopicDisplay">Robotics Workshop</div>
<button class="btn ghost small" onclick="openChangeTopic()" style="margin-top:4px;">✏️ Change Topic</button>
</div>
</div>

<button class="btn primary" onclick="startDelivery()" style="width:100%;padding:14px;font-size:16px;">
🚀 Start Delivery
</button>
</div>
</div>

<!-- STATE 3: School Picker View (Hidden by default) -->
<div id="SchoolPickerView" style="display:none;">
<button class="btn ghost small" onclick="backToSessionDetail()" style="margin-bottom:12px;">← Back to Session</button>

<div class="card" id="SchoolPickerCard">
<h3 style="margin:0 0 4px 0;" id="SchoolPickerTitle">📍 Select School to Deliver</h3>
<div class="muted" style="margin-bottom:12px;" id="SchoolPickerSubtitle">This session has 3 schools. Tap school to record demographics:</div>

<div id="SchoolList">
<div class="school-card" onclick="selectSchool('redfern')" id="school-redfern">
<div style="display:flex;align-items:center;justify-content:space-between;">
<div><strong>Redfern Public School</strong><div class="muted" style="font-size:12px;">Ms. Emma Riley • emma.riley@redfern.nsw.edu.au</div></div>
<span class="status-chip pending" id="status-redfern">🔴 Not Started</span>
</div>
<div class="survey-status" id="survey-status-redfern" style="margin-top:8px;font-size:12px;color:#6b7280;">
Student: 0 • Teacher: Not sent • Demographics: Pending
</div>
</div>

<div class="school-card" onclick="selectSchool('dubbo')" id="school-dubbo">
<div style="display:flex;align-items:center;justify-content:space-between;">
<div><strong>Dubbo College</strong><div class="muted" style="font-size:12px;">Mr. John Chen • john.chen@dubbo.nsw.edu.au</div></div>
<span class="status-chip pending" id="status-dubbo">🔴 Not Started</span>
</div>
<div class="survey-status" id="survey-status-dubbo" style="margin-top:8px;font-size:12px;color:#6b7280;">
Student: 0 • Teacher: Not sent • Demographics: Pending
</div>
</div>

<div class="school-card" onclick="selectSchool('kempsey')" id="school-kempsey">
<div style="display:flex;align-items:center;justify-content:space-between;">
<div><strong>Kempsey Public School</strong><div class="muted" style="font-size:12px;">Mrs. Sarah Lee • sarah.lee@kempsey.nsw.edu.au</div></div>
<span class="status-chip pending" id="status-kempsey">🔴 Not Started</span>
</div>
<div class="survey-status" id="survey-status-kempsey" style="margin-top:8px;font-size:12px;color:#6b7280;">
Student: 0 • Teacher: Not sent • Demographics: Pending
</div>
</div>
</div>

<div class="warning" style="margin-top:16px;"><strong>💡 What if a school doesn't show up?</strong><br>
Select the school and choose "Didn't Attend" to skip without entering demographics.</div>
</div>
</div>

<!-- Modals (available globally) -->

<!-- Modal for changing presenter -->
<div id="ChangePresenterModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:100;align-items:center;justify-content:center;">
<div style="background:white;border-radius:12px;padding:20px;max-width:350px;width:90%;margin:0 auto;">
<h3 style="margin:0 0 12px 0;">Change Presenter</h3>
<label style="font-size:13px;margin-bottom:6px;">Select new presenter:</label>
<select id="PresenterField" style="font-size:14px;padding:10px;margin-bottom:12px;">
<option value="Alex Brown">Alex Brown</option>
<option value="Jordan Smith">Jordan Smith</option>
<option value="Casey Lee">Casey Lee</option>
<option value="Emma Riley">Emma Riley</option>
<option value="John Chen">John Chen</option>
<option value="Sarah Lee">Sarah Lee</option>
<option value="Sarah Wilson">Sarah Wilson</option>
<option value="Rob Chen">Rob Chen</option>
</select>
<div class="btn-group" style="justify-content:flex-end;">
<button class="btn ghost small" onclick="cancelChangePresenter()">Cancel</button>
<button class="btn primary small" onclick="confirmChangePresenter()">✅ Confirm Change</button>
</div>
</div>
</div>

<!-- Modal for editing supporters -->
<div id="EditSupportersModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:100;align-items:center;justify-content:center;">
<div style="background:white;border-radius:12px;padding:20px;max-width:350px;width:90%;margin:0 auto;">
<h3 style="margin:0 0 12px 0;">Edit Supporting Presenters</h3>
<div id="SupportersList" style="margin-bottom:12px;"></div>
<label style="font-size:13px;margin-bottom:6px;">Add supporter:</label>
<select id="AddSupporterField" style="font-size:14px;padding:10px;margin-bottom:12px;">
<option value="">-- Select --</option>
<option value="Alex Brown">Alex Brown</option>
<option value="Jordan Smith">Jordan Smith</option>
<option value="Casey Lee">Casey Lee</option>
<option value="Emma Riley">Emma Riley</option>
<option value="John Chen">John Chen</option>
<option value="Sarah Lee">Sarah Lee</option>
<option value="Sarah Wilson">Sarah Wilson</option>
<option value="Rob Chen">Rob Chen</option>
</select>
<button class="btn secondary small" onclick="addSupporterToList()" style="width:100%;margin-bottom:12px;">➕ Add</button>
<div class="btn-group" style="justify-content:flex-end;">
<button class="btn ghost small" onclick="cancelEditSupporters()">Cancel</button>
<button class="btn primary small" onclick="confirmEditSupporters()">✅ Save Changes</button>
</div>
</div>
</div>

<!-- Modal for changing topic -->
<div id="ChangeTopicModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:100;align-items:center;justify-content:center;">
<div style="background:white;border-radius:12px;padding:20px;max-width:350px;width:90%;margin:0 auto;">
<h3 style="margin:0 0 12px 0;">Change Topic</h3>
<label style="font-size:13px;margin-bottom:6px;">Select new topic:</label>
<select id="TopicField" style="font-size:14px;padding:10px;margin-bottom:12px;">
<option value="Robotics Workshop">Robotics Workshop</option>
<option value="Coding Fundamentals">Coding Fundamentals</option>
<option value="Marine Biology">Marine Biology</option>
<option value="Astronomy & Space">Astronomy & Space</option>
<option value="Chemistry Experiments">Chemistry Experiments</option>
<option value="Engineering Design">Engineering Design</option>
</select>
<div class="btn-group" style="justify-content:flex-end;">
<button class="btn ghost small" onclick="cancelChangeTopic()">Cancel</button>
<button class="btn primary small" onclick="confirmChangeTopic()">✅ Confirm Change</button>
</div>
</div>
</div>

<div class="card" id="DemographicsSection" style="display:none;">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
<h3 style="margin:0;">Record Demographics</h3>
<button class="btn ghost small" onclick="backToSchoolPicker()">← Back</button>
</div>
<div class="success" style="margin-bottom:12px;">Recording for: <strong id="SelectedSchoolName">-</strong></div>

<!-- Teacher/Contact - Read Only with Report Issue -->
<div style="margin-bottom:12px;padding:12px;background:#F9FAFB;border:1px solid #e5e7eb;border-radius:8px;">
<label style="font-size:13px;margin-bottom:4px;color:#6b7280;">Teacher/Contact</label>
<div style="font-size:15px;font-weight:600;margin:4px 0;" id="TeacherContactDisplay">-</div>
<div style="font-size:12px;color:#6b7280;" id="TeacherContactEmail">-</div>
<button class="btn ghost small" onclick="reportContactIssue()" style="margin-top:8px;">🚩 Report Contact Issue</button>
</div>

<!-- Hidden form for reporting contact issue -->
<div id="ContactIssueForm" style="display:none;margin-bottom:12px;padding:12px;background:#FEF3C7;border:2px solid #F59E0B;border-radius:8px;">
<div style="font-weight:600;margin-bottom:8px;">⚠️ Report Contact Issue</div>
<label style="font-size:13px;margin-bottom:4px;">What's wrong with the contact info?</label>
<textarea id="ContactIssueNotes" rows="3" placeholder="e.g. Ms. Riley is on leave, spoke with Ms. Johnson instead" style="font-size:14px;padding:8px;margin-bottom:8px;"></textarea>
<label style="font-size:13px;margin-bottom:4px;">Who did you speak with? (optional)</label>
<input type="text" id="ContactIssueActualContact" placeholder="e.g. Ms. Johnson" style="font-size:14px;padding:8px;margin-bottom:8px;">
<div class="btn-group">
<button class="btn primary small" onclick="saveContactIssue()">✅ Submit Issue</button>
<button class="btn ghost small" onclick="cancelContactIssue()">Cancel</button>
</div>
</div>

<label>School Status *</label>
<select id="SchoolStatus" onchange="handleStatusChange()">
<option value="delivered">✅ Delivered (Enter demographics below)</option>
<option value="didnt_attend">⏭️ Didn't Attend (No show / Not present)</option>
<option value="cancelled">🚫 Cancelled (School cancelled before session)</option>
<option value="rescheduled">📅 Rescheduled (Moved to different date)</option>
</select>

<div id="DemographicsForm" data-edit-key="counts" style="display:block;">
<label>Total Students *</label>
<input type='number' id='TotalStudents' min='1' placeholder='e.g. 25' required onblur="prefillGender()">

<label>Aboriginal/Torres Strait Islander Students *</label>
<input type='number' id='ATSIStudents' min='0' placeholder='e.g. 12' required>

<label style="display:flex;align-items:center;font-weight:400;margin-top:12px;">
<input type="checkbox" id="YearLevelsNA" style="width:auto;margin-right:8px;" onchange="toggleYearLevels()">
Not Applicable (mixed ages, community event)
</label>

<div id="YearLevelSection">
<label>Year Levels Present *</label>
<div class="checkbox-group">
<label><input type="checkbox" name="grade" value="Foundation"> Foundation</label>
<label><input type="checkbox" name="grade" value="Year 1"> Year 1</label>
<label><input type="checkbox" name="grade" value="Year 2"> Year 2</label>
<label><input type="checkbox" name="grade" value="Year 3"> Year 3</label>
<label><input type="checkbox" name="grade" value="Year 4"> Year 4</label>
<label><input type="checkbox" name="grade" value="Year 5"> Year 5</label>
<label><input type="checkbox" name="grade" value="Year 6"> Year 6</label>
<label><input type="checkbox" name="grade" value="Year 7"> Year 7</label>
<label><input type="checkbox" name="grade" value="Year 8"> Year 8</label>
<label><input type="checkbox" name="grade" value="Year 9"> Year 9</label>
<label><input type="checkbox" name="grade" value="Year 10"> Year 10</label>
<label><input type="checkbox" name="grade" value="Year 11"> Year 11</label>
<label><input type="checkbox" name="grade" value="Year 12"> Year 12</label>
<label><input type="checkbox" name="grade" value="Mixed"> Mixed</label>
</div>
</div>

<label style="margin-top:16px;">Gender Breakdown (must equal total) *</label>
<div class="muted" style="margin-bottom:8px;">Required for Aboriginal female student reporting. Enter counts:</div>
<label style="font-weight:400;font-size:14px;">Male</label>
<input type="number" id="GenderMale" min="0" value="0" placeholder="0" oninput="validateGenderSum()">
<label style="font-weight:400;font-size:14px;margin-top:8px;">Female</label>
<input type="number" id="GenderFemale" min="0" value="0" placeholder="0" oninput="validateGenderSum()">
<label style="font-weight:400;font-size:14px;margin-top:8px;">Non-binary</label>
<input type="number" id="GenderNonBinary" min="0" value="0" placeholder="0" oninput="validateGenderSum()">
<label style="font-weight:400;font-size:14px;margin-top:8px;">Self-describe</label>
<input type="number" id="GenderSelfDescribe" min="0" value="0" placeholder="0" oninput="validateGenderSum()">
<label style="font-weight:400;font-size:14px;margin-top:8px;">Prefer not to say</label>
<input type="number" id="GenderPreferNot" min="0" value="0" placeholder="0" oninput="validateGenderSum()">
<label style="font-weight:400;font-size:14px;margin-top:8px;">Unknown/Not recorded</label>
<input type="number" id="GenderUnknown" min="0" value="0" placeholder="0" oninput="validateGenderSum()">

<div id="GenderValidation" class="muted" style="margin-top:8px;font-weight:600;color:#6b7280;">Sum: 0 of 0</div>

<!-- Survey Collection Checklist -->
<div class="survey-checklist">
<div class="survey-checklist-title">📋 Survey Collection Checklist</div>

<div class="survey-item" id="survey-item-student">
<div class="survey-item-icon">📱</div>
<div class="survey-item-content">
<div class="survey-item-title">Student Survey</div>
<div class="survey-item-status" id="student-survey-status">Not shown yet</div>
</div>
</div>
<div class="survey-actions">
<button class="btn primary" onclick="showQRFullScreen()">📱 Show QR Code</button>
<button class="btn ghost" onclick="copyStudentLink()">📋 Copy Link</button>
</div>

<div class="survey-item" id="survey-item-teacher" style="margin-top:12px;">
<div class="survey-item-icon">✉️</div>
<div class="survey-item-content">
<div class="survey-item-title">Teacher Feedback Survey</div>
<div class="survey-item-status" id="teacher-survey-status">Not sent yet</div>
</div>
</div>
<div class="survey-actions">
<button class="btn primary" onclick="sendTeacherFeedback(event)">✉️ Send Now</button>
<button class="btn ghost" onclick="copyTeacherFeedback()">📋 Copy Link</button>
</div>
</div>

<div class="save-btn-container">
<div class="save-warning" id="SaveWarning">
⚠️ <strong>Heads up:</strong> You're about to save demographics without completing survey collection. You can still collect surveys later, but it's easier now.
</div>
<button class='btn primary' onclick='saveDemographics()' style='margin-top:16px;'>Save Demographics</button>
</div>

<div id="ValidationWarning" class="error" style="display:none;margin-top:12px;"></div>
</div>

<div id="SkipSection" style="display:none;">
<label>Reason for Skipping *</label>
<textarea id="SkipReason" rows="3" placeholder="e.g. School didn't show up, rescheduled to next week, cancelled due to weather"></textarea>
<button class='btn danger' onclick='saveDemographics()' style='margin-top:16px;'>Save Status</button>
</div>
</div>

<div class="card" id="CompleteCard" style="display:none;">
<h3 style="margin:0 0 8px 0;">🎉 Ready to Complete</h3>
<div id="CompletionStatus"></div>
<div id="CompletionWarnings" style="margin-top:8px;"></div>
<button class="btn primary" onclick="markComplete()" style="margin-top:16px;">✅ Mark Session Complete</button>
</div>

</main>

</div>
</div>
</div>

<!-- QR Code Fullscreen -->
<div class="qr-fullscreen" id="QRFullScreen">
<div style="text-align:center;padding:24px;">
<h2 style="margin:0 0 8px 0;">📱 Student Survey</h2>
<div style="color:#6b7280;margin-bottom:24px;">Scan this QR code to complete the survey</div>
<div style="background:white;padding:24px;border-radius:16px;display:inline-block;">
<svg width="280" height="280" viewBox="0 0 280 280">
<rect width="280" height="280" fill="white"/>
<rect x="20" y="20" width="60" height="60" fill="black"/>
<rect x="200" y="20" width="60" height="60" fill="black"/>
<rect x="20" y="200" width="60" height="60" fill="black"/>
<rect x="30" y="30" width="40" height="40" fill="white"/>
<rect x="210" y="30" width="40" height="40" fill="white"/>
<rect x="30" y="210" width="40" height="40" fill="white"/>
<rect x="100" y="100" width="80" height="80" fill="black"/>
</svg>
</div>
<div style="margin-top:24px;color:#6b7280;font-size:14px;">https://forms.deadlyscience.org.au/survey/SESS-501</div>
<div style="margin-top:16px;color:#6b7280;font-size:13px;">Tap anywhere to close</div>
</div>
</div>

<script>
// v25: Deep link scroll targeting and conditional back link
(function() {
  const urlParams = new URLSearchParams(window.location.search);
  const fromParam = urlParams.get('from');
  const cameFromCompleteness = document.referrer.includes('data_completeness.html') || fromParam === 'data-completeness';

  if (cameFromCompleteness) {
    const backLink = document.getElementById('BackToCompletenessLink');
    if (backLink) {
      backLink.style.display = 'block';
    }
  }

  window.__cameFromDataCompleteness = cameFromCompleteness;

  // Handle ?edit= query parameter for scroll targeting
  const editKey = urlParams.get('edit'); // First value only
  
  if (editKey) {
    // Wait for page to load and session detail to be visible
    window.addEventListener('load', function() {
      // Map edit keys to selectors
      const keyMap = {
        'counts': '[data-edit-key="counts"]',
        'funding': '[data-edit-key="funding"]',
        'facilitator': '[data-edit-key="facilitator"]',
        'all': '[data-edit-key="counts"]' // Default to first editable section
      };
      
      const selector = keyMap[editKey] || keyMap['all'];
      const target = document.querySelector(selector);
      
      if (target) {
        setTimeout(function() {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 300); // Delay to ensure view is visible
      }
    });
  }
})();

// NEW: Audit trail storage
const auditLog = [];
const originalValues = {
  Presenter: 'Alex Brown',
  Supporting_Presenters: ['Jordan Smith'],  // Array for multiple supporters
  Topic: 'Robotics Workshop',
  Teacher_Contact: {}
};

// Track available contacts globally
const availableContacts = [
  'Ms. Emma Riley',
  'Mr. John Chen', 
  'Mrs. Sarah Lee',
  'Alex Brown',
  'Jordan Smith',
  'Casey Lee'
];

// NEW: Track modified fields
const modifiedFields = new Set();

// Session filter state
let showAllSessions = false;
let currentUser = 'Alex Brown'; // In production, would come from auth

// NEW: View state management
let currentView = 'list'; // 'list', 'detail', 'picker', 'demographics'
let currentSessionId = null;
let currentSessionData = {
  'SESS-501': {
    id: 'SESS-501',
    title: 'Robotics Workshop',
    time: 'Today 10:00 AM',
    presenter: 'Alex Brown',
    supporters: ['Jordan Smith'],
    topic: 'Robotics Workshop',
    schools: ['redfern', 'dubbo', 'kempsey'],
    isMultiSchool: true,
    isMine: true
  },
  'SESS-504': {
    id: 'SESS-504',
    title: 'Marine Biology',
    time: 'Today 11:30 AM',
    presenter: 'Sarah Wilson',
    supporters: [],
    topic: 'Marine Biology',
    schools: ['sydney_hs'],
    isMultiSchool: false,
    isMine: false
  },
  'SESS-506': {
    id: 'SESS-506',
    title: 'Coding Fundamentals',
    time: 'Today 2:00 PM',
    presenter: 'Rob Chen',
    supporters: ['Alex Brown'],
    topic: 'Coding Fundamentals',
    schools: ['dubbo_west'],
    isMultiSchool: false,
    isMine: false
  },
  'SESS-508': {
    id: 'SESS-508',
    title: 'Astronomy & Space',
    time: 'Tomorrow 9:00 AM',
    presenter: 'Casey Lee',
    supporters: [],
    topic: 'Astronomy & Space',
    schools: ['newcastle_central'],
    isMultiSchool: false,
    isMine: false
  }
};

function getPresenterToolsLink() {
  if (!currentSessionId) {
    return '';
  }
  return `https://deadlyscience.org/presenter-tools?session=${currentSessionId}`;
}

function openPresenterTools() {
  const link = getPresenterToolsLink();
  if (!link) {
    alert('Select a session to launch Presenter Tools Online.');
    return;
  }
  window.open(link, '_blank', 'noopener=yes');
}

function copyPresenterToolsLink() {
  const link = getPresenterToolsLink();
  if (!link) {
    alert('Select a session before copying the presenter link.');
    return;
  }

  const onSuccess = () => {
    alert(`✅ Presenter Tools link copied!\n\n${link}`);
  };

  const onFailure = () => {
    const helper = document.createElement('textarea');
    helper.value = link;
    helper.setAttribute('readonly', '');
    helper.style.position = 'absolute';
    helper.style.left = '-9999px';
    document.body.appendChild(helper);
    helper.select();
    document.execCommand('copy');
    document.body.removeChild(helper);
    alert(`✅ Presenter Tools link copied!\n\n${link}`);
  };

  if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
    navigator.clipboard.writeText(link).then(onSuccess).catch(onFailure);
  } else {
    onFailure();
  }
}

// NEW: Navigation functions
function openSessionDetail(sessionId) {
  currentSessionId = sessionId;
  const session = currentSessionData[sessionId];
  
  // Show coverage warning if not your session
  if (!session.isMine && showAllSessions) {
    if (!confirm(`⚠️ You're about to open session ${sessionId} which is assigned to ${session.presenter}.\n\nThis will be logged as coverage. Continue?`)) {
      return;
    }
    document.getElementById('PresenterInfo').style.display = 'block';
    document.getElementById('OriginalPresenterName').textContent = session.presenter;
  } else {
    document.getElementById('PresenterInfo').style.display = 'none';
  }

  const toolsContainer = document.getElementById('PresenterToolsOnline');
  const toolsRestriction = document.getElementById('PresenterToolsRestriction');
  if (toolsContainer && toolsRestriction) {
    toolsContainer.style.display = 'flex';
    if (session.presenter === currentUser) {
      toolsRestriction.textContent = 'Presenter Tools includes live access to edit Session__c attendance and trigger Survey_Response__c reminders.';
    } else {
      toolsRestriction.textContent = `${currentUser} is covering this delivery. Presenter Tools will open in read-only mode (Session__c.Presenter__c remains ${session.presenter}).`;
    }
  }

  // Update session detail view
  document.getElementById('SessionDetailTitle').textContent = `Session: ${sessionId}`;
  document.getElementById('SessionDetailSubtitle').textContent = `${session.title} • ${session.time}`;
  document.getElementById('PresenterDisplay').textContent = session.presenter;
  document.getElementById('SupportingDisplay').textContent = session.supporters.length > 0 ? session.supporters.join(', ') : 'None';
  document.getElementById('TopicDisplay').textContent = session.topic;
  
  // Update originalValues for this session
  originalValues.Presenter = session.presenter;
  originalValues.Supporting_Presenters = [...session.supporters];
  originalValues.Topic = session.topic;
  
  // Switch views
  document.getElementById('SessionListView').style.display = 'none';
  document.getElementById('SessionDetailView').style.display = 'block';
  document.getElementById('SchoolPickerView').style.display = 'none';
  
  currentView = 'detail';
  
  console.log('Opened session detail:', sessionId);
}

function backToSessionList() {
  document.getElementById('SessionListView').style.display = 'block';
  document.getElementById('SessionDetailView').style.display = 'none';
  document.getElementById('SchoolPickerView').style.display = 'none';
  
  currentView = 'list';
  currentSessionId = null;
  
  console.log('Back to session list');
}

function startDelivery() {
  const session = currentSessionData[currentSessionId];
  
  // If single-school session, go directly to that school's demographics
  if (!session.isMultiSchool && session.schools.length === 1) {
    const schoolId = session.schools[0];
    
    // For demo purposes with existing school data, redirect to redfern as placeholder
    // In production, would load the actual single school
    console.log('Single-school session, going directly to school:', schoolId);
    alert(`📍 Single-school session!\n\nWould load demographics for: ${schoolId}\n\nFor this demo, using multi-school flow to preserve existing functionality.`);
  }
  
  // Show school picker
  document.getElementById('SessionDetailView').style.display = 'none';
  document.getElementById('SchoolPickerView').style.display = 'block';
  
  // Update school picker title and subtitle (not the entire card!)
  const schoolCount = session.schools.length;
  const pickerTitle = session.isMultiSchool 
    ? `📍 Select School to Deliver`
    : `📍 Deliver Session`;
  
  const pickerSubtitle = session.isMultiSchool
    ? `This session has ${schoolCount} schools. Tap school to record demographics:`
    : `Recording demographics for this session:`;
  
  document.getElementById('SchoolPickerTitle').textContent = pickerTitle;
  document.getElementById('SchoolPickerSubtitle').textContent = pickerSubtitle;
  
  currentView = 'picker';
  
  console.log('Started delivery for session:', currentSessionId);
}

function backToSessionDetail() {
  document.getElementById('SessionDetailView').style.display = 'block';
  document.getElementById('SchoolPickerView').style.display = 'none';
  document.getElementById('DemographicsSection').style.display = 'none';
  
  currentView = 'detail';
  
  console.log('Back to session detail');
}

// NEW: Modal functions for presenter change
function openChangePresenter() {
  const currentPresenter = document.getElementById('PresenterDisplay').textContent;
  document.getElementById('PresenterField').value = currentPresenter;
  document.getElementById('ChangePresenterModal').style.display = 'flex';
}

function cancelChangePresenter() {
  document.getElementById('ChangePresenterModal').style.display = 'none';
}

function confirmChangePresenter() {
  const newValue = document.getElementById('PresenterField').value;
  const oldValue = originalValues.Presenter;
  
  if (newValue !== oldValue) {
    document.getElementById('PresenterDisplay').textContent = newValue;
    handleFieldChange('Presenter', newValue);
  }
  
  cancelChangePresenter();
}

// NEW: Modal functions for supporters
function openEditSupporters() {
  updateSupportersList();
  document.getElementById('EditSupportersModal').style.display = 'flex';
}

function openAddSupporter() {
  updateSupportersList();
  document.getElementById('EditSupportersModal').style.display = 'flex';
}

function updateSupportersList() {
  const container = document.getElementById('SupportersList');
  const supporters = originalValues.Supporting_Presenters;
  
  if (supporters.length === 0) {
    container.innerHTML = '<div class="muted" style="padding:8px;text-align:center;">No supporters added</div>';
  } else {
    container.innerHTML = supporters.map((supporter, index) => `
      <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:#F9FAFB;border-radius:6px;margin-bottom:6px;">
        <span>${supporter}</span>
        <button class="btn ghost small" onclick="removeSupporter(${index})" style="padding:4px 8px;">✕</button>
      </div>
    `).join('');
  }
}

function addSupporterToList() {
  const select = document.getElementById('AddSupporterField');
  const newSupporter = select.value;
  
  if (!newSupporter) {
    alert('Please select a supporter to add');
    return;
  }
  
  if (originalValues.Supporting_Presenters.includes(newSupporter)) {
    alert('This person is already a supporter');
    return;
  }
  
  originalValues.Supporting_Presenters.push(newSupporter);
  updateSupportersList();
  select.value = '';
}

function removeSupporter(index) {
  originalValues.Supporting_Presenters.splice(index, 1);
  updateSupportersList();
}

function cancelEditSupporters() {
  document.getElementById('EditSupportersModal').style.display = 'none';
  document.getElementById('AddSupporterField').value = '';
}

function confirmEditSupporters() {
  const supportersText = originalValues.Supporting_Presenters.length === 0 
    ? 'None' 
    : originalValues.Supporting_Presenters.join(', ');
  
  document.getElementById('SupportingDisplay').textContent = supportersText;
  
  // Log change to audit trail
  const timestamp = new Date().toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' });
  const logEntry = {
    field: 'Supporting_Presenters',
    oldValue: 'Jordan Smith', // Would track actual old value in production
    newValue: supportersText,
    timestamp: timestamp,
    source: 'Deliver App'
  };
  
  auditLog.push(logEntry);
  modifiedFields.add('Supporting_Presenters');
  
  console.log('🔄 Field Modified:', logEntry);
  
  cancelEditSupporters();
}

// NEW: Modal functions for topic change
function openChangeTopic() {
  const currentTopic = document.getElementById('TopicDisplay').textContent;
  document.getElementById('TopicField').value = currentTopic;
  document.getElementById('ChangeTopicModal').style.display = 'flex';
}

function cancelChangeTopic() {
  document.getElementById('ChangeTopicModal').style.display = 'none';
}

function confirmChangeTopic() {
  const newValue = document.getElementById('TopicField').value;
  const oldValue = originalValues.Topic;
  
  if (newValue !== oldValue) {
    document.getElementById('TopicDisplay').textContent = newValue;
    handleFieldChange('Topic', newValue);
  }
  
  cancelChangeTopic();
}

// NEW: Handle selecting other sessions (for Show All mode)
// NEW: Handle field changes with audit trail
function handleFieldChange(fieldName, newValue) {
  const timestamp = new Date().toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' });
  const oldValue = originalValues[fieldName];
  
  if (oldValue !== newValue) {
    // Add to audit log
    const logEntry = {
      field: fieldName,
      oldValue: oldValue,
      newValue: newValue,
      timestamp: timestamp,
      source: 'Deliver App'
    };
    
    auditLog.push(logEntry);
    modifiedFields.add(fieldName);
    
    // Update original value
    originalValues[fieldName] = newValue;
    
    // Log to console (in production, this would POST to Salesforce)
    console.log('🔄 Field Modified:', logEntry);
    console.log('📤 Salesforce Update:', {
      object: 'Session__c',
      recordId: 'SESS-501',
      fields: {
        [fieldName + '__c']: newValue,
        'Modified_in_Deliver__c': true,
        'Last_Modified_Field__c': fieldName,
        'Last_Modified_Timestamp__c': new Date().toISOString()
      }
    });
    
    // Note: No immediate warning - will show on completion
  }
}

// NEW: Report contact issue
function reportContactIssue() {
  document.getElementById('ContactIssueForm').style.display = 'block';
}

// NEW: Save contact issue report
function saveContactIssue() {
  const notes = document.getElementById('ContactIssueNotes').value.trim();
  const actualContact = document.getElementById('ContactIssueActualContact').value.trim();
  
  if (!notes) {
    alert('❌ Please describe the contact issue');
    return;
  }
  
  const timestamp = new Date().toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' });
  const expectedContact = schoolData[selectedSchool].contact;
  
  // Log to audit trail
  const logEntry = {
    field: `Contact Issue Reported (${schoolData[selectedSchool].name})`,
    oldValue: expectedContact,
    reportedValue: actualContact || 'Not specified',
    notes: notes,
    timestamp: timestamp,
    source: 'Deliver App'
  };
  
  auditLog.push(logEntry);
  
  console.log('🚩 Contact Issue Reported:', logEntry);
  console.log('📤 Salesforce Updates:', [
    {
      object: 'Session_School__c',
      recordId: selectedSchool,
      fields: {
        'Contact_Issue_Reported__c': true,
        'Contact_Issue_Notes__c': `[${timestamp}] ${notes}` + (actualContact ? ` - Spoke with: ${actualContact}` : ''),
        'Contact_Issue_Timestamp__c': new Date().toISOString()
      }
    },
    {
      object: 'Task',
      action: 'CREATE',
      fields: {
        'Type': 'Data Quality - Contact Update',
        'Related_To__c': selectedSchool,
        'Priority': 'Normal',
        'Subject': `Verify contact for ${schoolData[selectedSchool].name}`,
        'Description': notes
      }
    }
  ]);
  
  // Store contact issue in schoolData for later reference
  schoolData[selectedSchool].contactIssue = {
    reported: true,
    notes: notes,
    actualContact: actualContact,
    timestamp: timestamp
  };
  
  alert(`✅ Contact issue reported!\n\n"${notes}"\n\nCoordinator will be notified to update the contact information.`);
  cancelContactIssue();
}

// NEW: Cancel contact issue report
function cancelContactIssue() {
  document.getElementById('ContactIssueForm').style.display = 'none';
  document.getElementById('ContactIssueNotes').value = '';
  document.getElementById('ContactIssueActualContact').value = '';
}

// NEW: Toggle session filter
function toggleSessionFilter() {
  const filterValue = document.querySelector('input[name="sessionFilter"]:checked').value;
  showAllSessions = (filterValue === 'all');
  
  // Show/hide warning
  document.getElementById('ShowAllWarning').style.display = showAllSessions ? 'block' : 'none';
  
  // Show/hide other sessions in list view
  document.getElementById('OtherSessionsList').style.display = showAllSessions ? 'block' : 'none';
  
  console.log('Session Filter:', showAllSessions ? 'Show All' : 'My Sessions');
}

let selectedSchool = null;

const schoolData = {
  redfern: {
    name: 'Redfern Public School',
    contact: 'Ms. Emma Riley',
    email: 'emma.riley@redfern.nsw.edu.au',
    status: 'pending',
    recorded: false,
    qrShown: false,
    teacherFeedbackSent: false
  },
  dubbo: {
    name: 'Dubbo College',
    contact: 'Mr. John Chen',
    email: 'john.chen@dubbo.nsw.edu.au',
    status: 'pending',
    recorded: false,
    qrShown: false,
    teacherFeedbackSent: false
  },
  kempsey: {
    name: 'Kempsey Public School',
    contact: 'Mrs. Sarah Lee',
    email: 'sarah.lee@kempsey.nsw.edu.au',
    status: 'pending',
    recorded: false,
    qrShown: false,
    teacherFeedbackSent: false
  }
};

function selectSchool(schoolId) {
  selectedSchool = schoolId;
  document.getElementById('SchoolPickerView').style.display = 'none';
  document.getElementById('DemographicsSection').style.display = 'block';
  document.getElementById('SelectedSchoolName').textContent = schoolData[schoolId].name;
  
  // Populate read-only teacher/contact display
  document.getElementById('TeacherContactDisplay').textContent = schoolData[schoolId].contact;
  document.getElementById('TeacherContactEmail').textContent = schoolData[schoolId].email;
  
  if(schoolData[schoolId].recorded) {
    document.getElementById('SchoolStatus').value = schoolData[schoolId].status === 'complete' ? 'delivered' : 'didnt_attend';
    handleStatusChange();
  } else {
    document.getElementById('SchoolStatus').value = 'delivered';
    handleStatusChange();
  }
  
  currentView = 'demographics';
  
  updateSurveyChecklist();
  clearForm();
}

function backToSchoolPicker() {
  document.getElementById('SchoolPickerView').style.display = 'block';
  document.getElementById('DemographicsSection').style.display = 'none';
  selectedSchool = null;
  currentView = 'picker';
  clearForm();
}

function handleStatusChange() {
  const status = document.getElementById('SchoolStatus').value;
  
  if(status === 'delivered') {
    document.getElementById('DemographicsForm').style.display = 'block';
    document.getElementById('SkipSection').style.display = 'none';
  } else {
    document.getElementById('DemographicsForm').style.display = 'none';
    document.getElementById('SkipSection').style.display = 'block';
  }
}

function toggleYearLevels() {
  const isNA = document.getElementById('YearLevelsNA').checked;
  const section = document.getElementById('YearLevelSection');
  section.style.display = isNA ? 'none' : 'block';
  
  if(isNA) {
    document.querySelectorAll('input[name="grade"]').forEach(cb => cb.checked = false);
  }
}

function prefillGender() {
  const total = parseInt(document.getElementById('TotalStudents').value) || 0;
  const unknown = parseInt(document.getElementById('GenderUnknown').value) || 0;
  
  if(total > 0 && unknown === 0) {
    document.getElementById('GenderUnknown').value = total;
    validateGenderSum();
  }
}

function validateGenderSum() {
  const total = parseInt(document.getElementById('TotalStudents').value) || 0;
  const male = parseInt(document.getElementById('GenderMale').value) || 0;
  const female = parseInt(document.getElementById('GenderFemale').value) || 0;
  const nonBinary = parseInt(document.getElementById('GenderNonBinary').value) || 0;
  const selfDescribe = parseInt(document.getElementById('GenderSelfDescribe').value) || 0;
  const preferNot = parseInt(document.getElementById('GenderPreferNot').value) || 0;
  const unknown = parseInt(document.getElementById('GenderUnknown').value) || 0;
  
  const sum = male + female + nonBinary + selfDescribe + preferNot + unknown;
  const validation = document.getElementById('GenderValidation');
  
  validation.textContent = `Sum: ${sum} of ${total}`;
  
  if(sum === total && total > 0) {
    validation.style.color = '#0a7d57';
    validation.textContent += ' ✓';
  } else if(sum > total) {
    validation.style.color = '#c62828';
    validation.textContent += ' (too high)';
  } else {
    validation.style.color = '#6b7280';
  }
}

function checkSurveyCompletion() {
  const data = schoolData[selectedSchool];
  return data.qrShown && data.teacherFeedbackSent;
}

function saveDemographics() {
  const status = document.getElementById('SchoolStatus').value;
  const warning = document.getElementById('ValidationWarning');
  
  if(status !== 'delivered') {
    const reason = document.getElementById('SkipReason').value.trim();
    if(!reason) {
      warning.textContent = '❌ Please provide a reason for skipping this school';
      warning.style.display = 'block';
      return;
    }
    
    schoolData[selectedSchool].status = status;
    schoolData[selectedSchool].recorded = true;
    
    const chip = document.getElementById('status-' + selectedSchool);
    chip.textContent = status === 'didnt_attend' ? '⏭️ Skipped' : '🚫 Cancelled';
    chip.className = 'status-chip ' + (status === 'didnt_attend' ? 'skipped' : 'cancelled');
    
    const card = document.getElementById('school-' + selectedSchool);
    card.className = 'school-card ' + (status === 'didnt_attend' ? 'skipped' : 'cancelled');
    
    alert(`School marked as ${status}\nReason: ${reason}\n\nIn Salesforce: Updates Session_School__c.Status__c and logs reason to Notes__c`);
    backToSchoolPicker();
    return;
  }
  
  const total = parseInt(document.getElementById('TotalStudents').value);
  const atsi = parseInt(document.getElementById('ATSIStudents').value);
  const yearNA = document.getElementById('YearLevelsNA').checked;
  const grades = Array.from(document.querySelectorAll('input[name="grade"]:checked')).map(cb => cb.value);
  
  const male = parseInt(document.getElementById('GenderMale').value) || 0;
  const female = parseInt(document.getElementById('GenderFemale').value) || 0;
  const nonBinary = parseInt(document.getElementById('GenderNonBinary').value) || 0;
  const selfDescribe = parseInt(document.getElementById('GenderSelfDescribe').value) || 0;
  const preferNot = parseInt(document.getElementById('GenderPreferNot').value) || 0;
  const unknown = parseInt(document.getElementById('GenderUnknown').value) || 0;
  const genderSum = male + female + nonBinary + selfDescribe + preferNot + unknown;
  
  if(!total || total < 1) { warning.textContent = '❌ Please enter total students (must be 1 or more)'; warning.style.display = 'block'; return; }
  if(isNaN(atsi) || atsi < 0) { warning.textContent = '❌ Please enter ATSI students (0 if none)'; warning.style.display = 'block'; return; }
  if(atsi > total) { warning.textContent = '❌ ATSI students cannot exceed total students'; warning.style.display = 'block'; return; }
  if(!yearNA && grades.length === 0) { warning.textContent = '❌ Please select at least one year level or check Not Applicable'; warning.style.display = 'block'; return; }
  if(genderSum !== total) { warning.textContent = `❌ Gender (${genderSum}) must equal total (${total}). Required for Aboriginal female reporting.`; warning.style.display = 'block'; return; }
  
  const surveysComplete = checkSurveyCompletion();
  if(!surveysComplete) {
    if(!confirm('⚠️ You haven\'t completed the survey collection.\n\nStudent QR: ' + (schoolData[selectedSchool].qrShown ? '✅' : '❌') + '\nTeacher Survey: ' + (schoolData[selectedSchool].teacherFeedbackSent ? '✅' : '❌') + '\n\nSave demographics anyway? You can send surveys later, but it\'s easier to do now.')) {
      return;
    }
  }
  
  warning.style.display = 'none';
  schoolData[selectedSchool].status = 'complete';
  schoolData[selectedSchool].recorded = true;
  
  const chip = document.getElementById('status-' + selectedSchool);
  chip.textContent = '✅ Complete';
  chip.className = 'status-chip complete';
  
  const surveyStatus = document.getElementById('survey-status-' + selectedSchool);
  surveyStatus.textContent = `Student: ${schoolData[selectedSchool].qrShown ? '✅' : '❌'} • Teacher: ${schoolData[selectedSchool].teacherFeedbackSent ? '✅' : '❌'} • Demographics: ✅`;
  surveyStatus.style.color = '#065F46';
  
  alert(`✅ Demographics saved!\nTotal: ${total} students\nATSI: ${atsi}\nYear Levels: ${grades.join(', ')}\n\nIn Salesforce: POST to Session_Demographics__c object\nFields: Total_Students__c, ATSI_Students__c, Year_Levels__c, Gender_Breakdown__c`);
  backToSchoolPicker();
}

function updateSurveyChecklist() {
  const data = schoolData[selectedSchool];
  
  const studentItem = document.getElementById('survey-item-student');
  const teacherItem = document.getElementById('survey-item-teacher');
  
  if(data.qrShown) {
    studentItem.classList.add('completed');
    document.getElementById('student-survey-status').textContent = '✅ QR code shown • Auto-linked to session';
    studentItem.querySelector('.survey-item-icon').textContent = '✅';
  } else {
    studentItem.classList.remove('completed');
    document.getElementById('student-survey-status').textContent = 'Not shown yet';
    studentItem.querySelector('.survey-item-icon').textContent = '📱';
  }
  
  if(data.teacherFeedbackSent) {
    teacherItem.classList.add('completed');
    document.getElementById('teacher-survey-status').textContent = '✅ Survey sent • Auto-reminders at 24/48/72hrs';
    teacherItem.querySelector('.survey-item-icon').textContent = '✅';
  } else {
    teacherItem.classList.remove('completed');
    
    // Check for contact issue and show warning
    if (data.contactIssue && data.contactIssue.reported) {
      document.getElementById('teacher-survey-status').innerHTML = 
        'Not sent yet<br><span style="color:#F59E0B;font-size:12px;">⚠️ Contact issue reported</span>';
    } else {
      document.getElementById('teacher-survey-status').textContent = 'Not sent yet';
    }
    
    teacherItem.querySelector('.survey-item-icon').textContent = '✉️';
  }
  
  checkSurveyCompletion();
}

function showQRFullScreen() {
  document.getElementById('QRFullScreen').classList.add('active');
  schoolData[selectedSchool].qrShown = true;
  updateSurveyChecklist();
}

function hideQRFullScreen() {
  document.getElementById('QRFullScreen').classList.remove('active');
}

document.getElementById('QRFullScreen').addEventListener('click', hideQRFullScreen);

function copyStudentLink() {
  const link = 'https://forms.deadlyscience.org.au/survey/SESS-501';
  navigator.clipboard.writeText(link);
  alert('✅ Student survey link copied to clipboard!\n\n' + link);
}

function sendTeacherFeedback(event) {
  if(event) event.stopPropagation();
  
  const school = schoolData[selectedSchool];
  
  // Check if there's a contact issue reported
  if (school.contactIssue && school.contactIssue.reported) {
    const issueNotes = school.contactIssue.notes;
    const actualContact = school.contactIssue.actualContact;
    
    // Build warning message
    let warningMsg = `⚠️ Contact Issue Reported\n\n`;
    warningMsg += `You noted: "${issueNotes}"\n\n`;
    if (actualContact) {
      warningMsg += `You spoke with: ${actualContact}\n`;
    }
    warningMsg += `\nSurvey will be sent to:\n${school.email}\n\n`;
    warningMsg += `Do you want to send the survey anyway?\n\n`;
    warningMsg += `• Yes → Send to ${school.contact}'s email\n`;
    warningMsg += `• No → Skip (coordinator will follow up manually)`;
    
    if (!confirm(warningMsg)) {
      // User chose to skip
      alert(`⏭️ Teacher survey skipped\n\nThis will be flagged for coordinator follow-up with the correct contact.`);
      return; // Exit without sending
    }
  }
  
  // Normal send flow (either no contact issue, or user chose to send anyway)
  if(confirm(`Send teacher feedback survey to ${school.contact}?\n\n✉️ Auto-reminders:\n• 24hr\n• 48hr\n• 72hr (final, CC coordinator)`)) {
    school.teacherFeedbackSent = true;
    updateSurveyChecklist();
    alert(`✅ Feedback survey sent to ${school.email}\n\nIn Salesforce: Creates Task__c record with Type="Send Teacher Survey"\nTriggers Zapier webhook to Typeform/SurveyMonkey\nStatus updates to Session_School__c.Teacher_Survey_Sent__c = true`);
  }
}

function copyTeacherFeedback() {
  const link = 'https://forms.deadlyscience.org.au/feedback/SESS-501';
  navigator.clipboard.writeText(link);
  alert('✅ Teacher feedback link copied to clipboard!\n\n' + link);
}

function updateCompleteButton() {
  const all = Object.values(schoolData);
  const completed = all.filter(s => s.recorded);
  const pending = all.filter(s => !s.recorded);
  
  if(completed.length === all.length) {
    document.getElementById('CompleteCard').style.display = 'block';
    
    const warnings = [];
    const qrNotShown = all.filter(s => s.status === 'complete' && !s.qrShown);
    const teacherNotSent = all.filter(s => s.status === 'complete' && !s.teacherFeedbackSent);
    
    if(qrNotShown.length > 0) {
      warnings.push(`<div class="warning">⚠️ <strong>QR Code not shown</strong> for ${qrNotShown.length} school(s). Student feedback can still be collected later via link.</div>`);
    }
    
    if(teacherNotSent.length > 0) {
      warnings.push(`<div class="warning">⚠️ <strong>Teacher feedback not sent</strong> for ${teacherNotSent.length} school(s). Can be sent from Session detail page.</div>`);
    }
    
    document.getElementById('CompletionWarnings').innerHTML = warnings.join('');
    
    const delivered = all.filter(s => s.status === 'complete').length;
    const skipped = all.filter(s => s.status !== 'complete' && s.recorded).length;
    
    document.getElementById('CompletionStatus').innerHTML = `
      <div style="font-size:13px;">
        <strong>Delivered:</strong> ${delivered}/${all.length} schools<br>
        ${skipped > 0 ? `<strong>Skipped/Cancelled:</strong> ${skipped}` : ''}
      </div>
    `;
  } else {
    document.getElementById('CompleteCard').style.display = 'none';
  }
}

setInterval(updateCompleteButton, 500);

function markComplete() {
  const delivered = Object.values(schoolData).filter(s => s.status === 'complete').length;
  const total = Object.keys(schoolData).length;
  
  // Build change summary
  let changesSummary = '';
  const sessionChanges = auditLog.filter(entry => 
    entry.field === 'Presenter' || 
    entry.field === 'Supporting_Presenters' || 
    entry.field === 'Topic'
  );
  
  const contactIssues = auditLog.filter(entry => 
    entry.field && entry.field.includes('Contact Issue')
  );
  
  if (sessionChanges.length > 0 || contactIssues.length > 0) {
    changesSummary = '\n\n⚠️ Changes made during this session:\n';
    
    sessionChanges.forEach(change => {
      let fieldName = change.field.replace(/_/g, ' ');
      if (fieldName === 'Supporting Presenters') {
        fieldName = 'Supporters';
      }
      changesSummary += `\n• ${fieldName}: ${change.oldValue} → ${change.newValue}`;
    });
    
    if (contactIssues.length > 0) {
      changesSummary += `\n\n🚩 Contact issues reported: ${contactIssues.length}`;
    }
    
    changesSummary += '\n\nThese changes will update in Salesforce and appear in reports.';
  }
  
  // Build coverage note if in "Show All" mode
  let coverageNote = '';
  if (showAllSessions) {
    coverageNote = '\n\n📋 Coverage Mode Active\nDelivered by: ' + currentUser + '\nOriginal Presenter: Alex Brown';
  }
  
  const confirmMessage = `Mark session SESS-501 as complete?

Delivered to: ${delivered}/${total} schools${changesSummary}${coverageNote}

In Salesforce: Updates Session__c.Status__c to "Completed" and End_Date__c to today`;
  
  if(confirm(confirmMessage)) {
    // Log final completion with all metadata
    console.log('✅ Session Completed:', {
      session_id: 'SESS-501',
      delivered_by: currentUser,
      original_presenter: 'Alex Brown',
      coverage_mode: showAllSessions,
      schools_delivered: delivered,
      schools_total: total,
      changes_made: sessionChanges.length,
      contact_issues: contactIssues.length,
      audit_log: auditLog
    });
    
    alert('✅ Session marked complete!\n\nSalesforce Actions:\n• Session__c.Status__c = "Completed"\n• Session__c.End_Date__c = TODAY()' + 
          (showAllSessions ? '\n• Delivered_By__c = "' + currentUser + '"' : '') +
          (sessionChanges.length > 0 ? '\n• Modified_in_Deliver__c = true' : '') +
          '\n• Creates Activity History record\n• Triggers completion notification email to coordinator');
  }
}

function clearForm() {
  document.getElementById('TotalStudents').value = '';
  document.getElementById('ATSIStudents').value = '';
  document.getElementById('YearLevelsNA').checked = false;
  toggleYearLevels();
  document.querySelectorAll('input[name="grade"]').forEach(cb => cb.checked = false);
  ['GenderMale','GenderFemale','GenderNonBinary','GenderSelfDescribe','GenderPreferNot','GenderUnknown'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('SkipReason').value = '';
  document.getElementById('ValidationWarning').style.display = 'none';
  document.getElementById('SaveWarning').classList.remove('show');
  
  // Hide contact issue form if visible
  cancelContactIssue();
}

// v25: Deep-link scroll targeting
window.addEventListener('DOMContentLoaded', function() {
  // Handle conditional back link
  const urlParams = new URLSearchParams(window.location.search);
  const fromParam = urlParams.get('from');
  const cameFromCompleteness = window.__cameFromDataCompleteness || document.referrer.includes('data_completeness.html') || fromParam === 'data-completeness';

  if (!cameFromCompleteness) {
    const backLink = document.querySelector('a[href="data_completeness.html"]');
    if (backLink && backLink.parentElement) {
      backLink.parentElement.style.display = 'none';
    }
  }

  // Handle edit parameter for scroll targeting
  const editKey = urlParams.get('edit');
  
  if (editKey) {
    const keyMap = {
      'counts': '[data-edit-key="counts"]',
      'funding': '[data-edit-key="funding"]',
      'facilitator': '[data-edit-key="facilitator"]',
      'all': '[data-edit-key="counts"]' // Default to first editable section
    };
    
    const selector = keyMap[editKey] || keyMap['all'];
    const target = document.querySelector(selector);
    
    if (target) {
      // Small delay to ensure page is fully rendered
      setTimeout(() => {
        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 300);
    }
  }
});

// === MINIMAL FILTER SYSTEM (Added for MVP) ===

const userId = 'user_12345';
const storageKey_deliver = 'ds_filters_deliver_' + userId;

let filterState = {
  dateRange: 'upcoming_90',
  status: ['Scheduled']
};

// Load saved filters on init
function initFilters() {
  const saved = localStorage.getItem(storageKey_deliver);
  if (saved) {
    try {
      filterState = JSON.parse(saved);
    } catch (e) {
      console.warn('Using default filters');
    }
  }
  applyFilterUI();
  filterSessions();
}

function toggleDateFilter(range) {
  filterState.dateRange = range;
  
  // Update UI
  document.querySelectorAll('[data-filter="date"]').forEach(btn => {
    const isActive = btn.dataset.value === range;
    btn.classList.toggle('active', isActive);
    btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
  });
  
  saveAndApplyFilters();
}

function toggleStatusFilter(status) {
  // Toggle status in array
  const idx = filterState.status.indexOf(status);
  if (idx > -1) {
    if (filterState.status.length > 1) { // Keep at least one
      filterState.status.splice(idx, 1);
    }
  } else {
    filterState.status.push(status);
  }
  
  // Update UI
  document.querySelectorAll('[data-filter="status"]').forEach(btn => {
    const isActive = filterState.status.includes(btn.dataset.value);
    btn.classList.toggle('active', isActive);
    btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
  });
  
  saveAndApplyFilters();
}

function saveAndApplyFilters() {
  localStorage.setItem(storageKey_deliver, JSON.stringify(filterState));
  filterSessions();
}

function applyFilterUI() {
  // Set active state on chips based on filterState
  document.querySelectorAll('[data-filter="date"]').forEach(btn => {
    const isActive = btn.dataset.value === filterState.dateRange;
    btn.classList.toggle('active', isActive);
    btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
  });

  document.querySelectorAll('[data-filter="status"]').forEach(btn => {
    const isActive = filterState.status.includes(btn.dataset.value);
    btn.classList.toggle('active', isActive);
    btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
  });
}

function filterSessions() {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  let rangeStart, rangeEnd;
  
  switch (filterState.dateRange) {
    case 'past_7':
      rangeStart = new Date(today);
      rangeStart.setDate(rangeStart.getDate() - 7);
      rangeEnd = today;
      break;
    case 'upcoming_90':
      rangeStart = today;
      rangeEnd = new Date(today);
      rangeEnd.setDate(rangeEnd.getDate() + 90);
      break;
    case 'this_year':
      rangeStart = new Date(today.getFullYear(), 0, 1);
      rangeEnd = new Date(today.getFullYear(), 11, 31);
      break;
  }
  
  // Filter all session cards
  const allCards = document.querySelectorAll('.session-card');
  let visibleCount = 0;
  
  allCards.forEach(card => {
    let show = true;
    
    // Scope filter (respect existing My Sessions / All Sessions toggle)
    const cardScope = card.dataset.scope;
    if (!showAllSessions && cardScope !== 'mine') {
      show = false;
    }
    
    // Date filter
    const cardDate = new Date(card.dataset.date);
    cardDate.setHours(0, 0, 0, 0);
    if (cardDate < rangeStart || cardDate > rangeEnd) {
      show = false;
    }
    
    // Status filter
    const cardStatus = card.dataset.status;
    if (!filterState.status.includes(cardStatus)) {
      show = false;
    }
    
    card.style.display = show ? 'block' : 'none';
    if (show) visibleCount++;
  });
  
  // Update warning banner
  updateWarningBanner();
}

function updateWarningBanner() {
  const banner = document.getElementById('ShowAllWarningBanner');
  if (banner) {
    banner.style.display = showAllSessions ? 'block' : 'none';
  }
}

// Hook into existing toggleSessionFilter to refresh filters
const originalToggle = toggleSessionFilter;
toggleSessionFilter = function() {
  originalToggle();
  filterSessions();
};

// Initialize on load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initFilters);
} else {
  initFilters();
}

// === END MINIMAL FILTER SYSTEM ===


</script>

</body></html>